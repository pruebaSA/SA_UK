Type.registerNamespace("Sys.Extended.UI");Sys.Extended.UI.AjaxFileUpload=function(c){var b=null,a=this;Sys.Extended.UI.AjaxFileUpload.initializeBase(a,[c]);a._postBackUrl="";a._progressBar=b;a._inputFileElement=b;a._iframe=b;a._vForm=b;a._filesInQueue=[];a._currentQueueIndex=0;a._webRequest=b;a._executor=b;a._isFileApiSupports=false;a._waitTimer=b;a._contextKey=b;a._throbber=b;a._guid="";a._isCancelUpload=false;a._isUploading=false;a._maximumNumberOfFiles=10;a._allowedFileTypes="";a._inputFileTemplate=b;a._inputFileElement=document.getElementById(a.get_id()+"_InputFileElement");a._queueContainer=document.getElementById(a.get_id()+"_QueueContainer");a._selectFileButton=document.getElementById(a.get_id()+"_SelectFileButton");a._uploadOrCancelButton=document.getElementById(a.get_id()+"_UploadOrCancelButton");a._progressBar=document.getElementById(a.get_id()+"_ProgressBar");a._progressBarContainer=document.getElementById(a.get_id()+"_ProgressBarContainer");a._fileStatusContainer=document.getElementById(a.get_id()+"_FileStatusContainer");a._footer=document.getElementById(a.get_id()+"_Footer");a._html5DropZone=document.getElementById(a.get_id()+"_Html5DropZone");a._html5InputFile=document.getElementById(a.get_id()+"_Html5InputFile");a._onFileSelected$delegate=Function.createDelegate(a,a._onFileSelected);a._onUploadOrAbort$delegate=Function.createDelegate(a,a._onUploadOrAbort);a._html5OnFileDropped$delegate=Function.createDelegate(a,a._html5OnFileDropped);a._html5OnDragOver$delegate=Function.createDelegate(a,a._html5OnDragOver);a._removeFromQueue$delegate=Function.createDelegate(a,a._removeFromQueue);if(typeof WebForm_OnSubmit=="function"&&!Sys.Extended.UI.AjaxFileUpload._originalWebForm_OnSubmit){Sys.Extended.UI.AjaxFileUpload._originalWebForm_OnSubmit=WebForm_OnSubmit;WebForm_OnSubmit=Sys.Extended.UI.AjaxFileUpload.WebForm_OnSubmit}};Sys.Extended.UI.AjaxFileUpload.prototype={initialize:function(){var a=this;Sys.Extended.UI.AjaxFileUpload.callBaseMethod(a,"initialize");if(window.File&&window.FileReader&&window.FileList&&window.Blob&&(new XMLHttpRequest).upload)a._isFileApiSupports=true;a._initTemplates();a._initHandlers();a._initLayout();a._reset();a._showFilesCount()},_initTemplates:function(){this._inputFileTemplate={nodeName:"input",properties:{type:"file",style:{zIndex:999,cursor:"pointer",position:"absolute"}}}},_initHandlers:function(){var a=this,b=null;if(!a._isFileApiSupports)b=a._inputFileElement;else{$addHandlers(a._html5DropZone,{drop:a._html5OnFileDropped$delegate});$addHandlers(a._html5DropZone,{dragover:a._html5OnDragOver$delegate});b=a._html5InputFile}a._attachFileInputHandlers(b,true);$addHandlers(a._uploadOrCancelButton,{click:a._onUploadOrAbort$delegate})},_initLayout:function(){var a=this,b=$common.getSize(a._footer),c=$common.getSize(a._uploadOrCancelButton).width,d={height:b.height,width:b.width-c};if(!a._isFileApiSupports){$common.setVisible(a._html5DropZone,false);$common.setVisible(a._html5InputFile,false);fileElement=a._inputFileElement}else $common.setVisible(a._inputFileElement,false)},_attachFileInputHandlers:function(a,b){if(b)$addHandlers(a,{change:this._onFileSelected$delegate});else $common.removeHandlers(a,{change:this._onFileSelected$delegate})},_setStatusMessage:function(a){this._fileStatusContainer.innerHTML=a},dispose:function(){var a=this;if(a._isFileApiSupports){Sys.Extended.UI.AjaxFileUpload._removeEvent(a._html5DropZone,"drop",a._html5OnFileDropped$delegate);Sys.Extended.UI.AjaxFileUpload._removeEvent(a._html5DropZone,"dragover",a._html5OnDragOver$delegate);Sys.Extended.UI.AjaxFileUpload._removeEvent(a._html5InputFile,"change",a._onFileSelected$delegate)}Sys.Extended.UI.AjaxFileUpload._removeEvent(a._uploadOrCancelButton,"click",a._onUploadOrAbort$delegate);a._removeIframe();a._removeVForm();Sys.Extended.UI.AjaxFileUpload.callBaseMethod(a,"dispose")},_html5OnFileDropped:function(a){a.stopPropagation();a.preventDefault();this._html5AddFileInQueue(a.rawEvent.dataTransfer.files)},_html5OnDragOver:function(a){a.stopPropagation();a.preventDefault()},_html5UploadFile:function(d){var a=this;a._guid=Sys.Extended.UI.AjaxFileUpload.utils.generateGuid();var b=d.get_fileInputElement(),c=new FormData;c.append("fileId",b.id);c.append("Filedata",b.file);$common.setVisible(a._progressBar,true);a._setDisableControls(true);a._html5SetPercent(0);a._setStatusMessage(String.format(Sys.Extended.UI.Resources.AjaxFileUpload_UploadingHtml5File,b.file.name,Sys.Extended.UI.AjaxFileUpload.utils.sizeToString(b.file.size)));a._webRequest=new Sys.Net.WebRequest;a._executor=new Sys.Net.XMLHttpExecutor;a._webRequest.set_url(a._postBackUrl+"?contextkey="+a._contextKey+"&guid="+a._guid);a._webRequest.set_httpVerb("POST");a._webRequest.add_completed(a.bind(a._html5OnRequestCompleted,a));a._executor.add_progress(a.bind(a._html5OnProgress,a));a._executor.add_uploadAbort(a.bind(a._html5OnAbort,a));a._executor.add_error(a.bind(a._html5OnError,a));a._webRequest.set_executor(a._executor);a._executor.executeRequest(c)},_html5OnRequestCompleted:function(c){var a=null;if(c.get_responseAvailable()){a=c.get_responseData();a=a.substring(a.indexOf("{"),a.lastIndexOf("}")+1);a=Sys.Serialization.JavaScriptSerializer.deserialize(a)}this._html5SetPercent(100);var b=this;setTimeout(function(){var c=b._getCurrentFileItem().get_fileInputElement().file,d;if(a!=null)d=new Sys.Extended.UI.AjaxFileUploadEventArgs(b._guid,"Success",a.FileName,a.FileSize,a.ContentType,a.PostedUrl);else d=new Sys.Extended.UI.AjaxFileUploadEventArgs(b._guid,"Success",c.fileName,c.fileSize,c.type,"");b._raiseUploadComplete(d);b._processNextFile()},100)},_html5OnProgress:function(b,a){a.lengthComputable&&this._html5SetPercent(Math.round(a.loaded*100/a.total))},_html5OnAbort:function(){this._setAborted()},_html5OnError:function(){this._reset();this._setError(Sys.Extended.UI.Resources.AjaxFileUpload_UploadError)},_html5SetPercent:function(a){this._progressBar.style.width=a+"%";$common.setText(this._progressBar,String.format(Sys.Extended.UI.Resources.AjaxFileUpload_UploadedPercentage,a))},_html5AddFileInQueue:function(e){for(var d=0;d<e.length;d++){var a=e[d],c;if(a.type!="")c=a.type.substring(a.type.lastIndexOf("/")+1);else c=a.name.substring(a.name.lastIndexOf(".")+1);if(this._validateFileType(c)){var b={};b.file=a;b.id=Sys.Extended.UI.AjaxFileUpload.utils.generateGuid();this._addToQueue(b)}}},_createInputFileElement:function(){var a=this;a._inputFileElement.style.zIndex=-999;$common.setLocation(a._inputFileElement,{x:-99999,y:-99999});a._attachFileInputHandlers(a._inputFileElement,false);var b=a.get_id()+"_file_"+Sys.Extended.UI.AjaxFileUpload.utils.generateGuid();a._inputFileElement=$common.createElementFromTemplate(a._inputFileTemplate,a._inputFileElement.parentNode);a._inputFileElement.setAttribute("id",b);a._inputFileElement.setAttribute("name",b);a._inputFileElement.style.zIndex=0;$common.setElementOpacity(a._inputFileElement,0);a._attachFileInputHandlers(a._inputFileElement,true)},_uploadInput_complete:function(a){this._removeVForm();this._raiseUploadComplete(a);this._processNextFile()},_setQueueStatuses:function(d,e,c){for(var a=c;a<this._filesInQueue.length;a++){var b=this._filesInQueue[a];b&&b.setStatus(d,e)}},_setAborted:function(){var a=this;a._setStatusMessage(Sys.Extended.UI.Resources.AjaxFileUpload_UploadCanceled);a._setQueueStatuses("cancelled",Sys.Extended.UI.Resources.AjaxFileUpload_Canceled,a._currentQueueIndex);a._uploadOrCancelButton.style.disabled="";a._reset()},_setError:function(b){var a=this;a._setStatusMessage(b?b:Sys.Extended.UI.Resources.AjaxFileUpload_DefaultError);a._setQueueStatuses("error",Sys.Extended.UI.Resources.AjaxFileUpload_error,a._currentQueueIndex);a._reset()},_reset:function(c){var b=false,a=this;a._isCancelUpload=b;a._setDisableControls(b);a._currentQueueIndex=0;a._html5DropZone.innerHTML=Sys.Extended.UI.Resources.AjaxFileUpload_DropFiles;a._selectFileButton.innerHTML=Sys.Extended.UI.Resources.AjaxFileUpload_SelectFile;a._uploadOrCancelButton.innerHTML=Sys.Extended.UI.Resources.AjaxFileUpload_Upload;if(a._isFileApiSupports)$common.setVisible(a._progressBar,b);else{a.setThrobber(b);a._removeIframe()}if(c){a._filesInQueue=[];a._hideSelectFileButton(b)}},_processNextFile:function(){var a=this;a._currentQueueIndex+=1;var b=a._getCurrentFileItem();if(b==null){a._setStatusMessage(Sys.Extended.UI.Resources.AjaxFileUpload_AllFilesUploaded);a._reset(true);return}if(b._isUploaded)a._processNextFile();else{b.setStatus("uploading",Sys.Extended.UI.Resources.AjaxFileUpload_Uploading);if(a._isFileApiSupports)a._html5UploadFile(b);else a._uploadInputElement(b)}},_uploadInputElement:function(c){var b=c.get_fileInputElement(),a=this;a._guid=Sys.Extended.UI.AjaxFileUpload.utils.generateGuid();setTimeout(function(){a._setStatusMessage(String.format(Sys.Extended.UI.Resources.AjaxFileUpload_UploadingInputFile,Sys.Extended.UI.AjaxFileUpload.utils.getFileName(b.value)));a._setDisableControls(true);a.setThrobber(true)},0);a._createVForm();a._vForm.appendChild(b);a._vForm.action=a._postBackUrl+"?contextkey="+this._contextKey+"&guid="+this._guid;a._vForm.target=a._iframeName;setTimeout(function(){a._vForm.submit();a._waitTimer=setTimeout(function(){a._wait()},100)},0)},setThrobber:function(a){if(this.get_throbber()!=null)this.get_throbber().style.display=a?"":"none"},_onFileSelected:function(c){var a=this;if(!a._isFileApiSupports){var b=a._inputFileElement.value;b=b.substring(b.lastIndexOf(".")+1);if(a._validateFileType(b)){a._addToQueue(a._inputFileElement);a._createInputFileElement()}}else a._html5AddFileInQueue(c.target.files)},_showFilesCount:function(){var a=this,b=a._queueContainer.childNodes.length==0&&a._filesInQueue.length==0;$common.setVisible(a._footer,!b);$common.setVisible(a._queueContainer,!b);if(b){a._setStatusMessage(Sys.Extended.UI.Resources.AjaxFileUpload_SelectFileToUpload);return}var c=a._filesInQueue.length>1?"s":"";a._setStatusMessage(String.format(Sys.Extended.UI.Resources.AjaxFileUpload_FileInQueue,a._filesInQueue.length.toString()))},_createIframe:function(){var b=this;b._onIframeLoad$delegate=Function.createDelegate(b,b._onIframeLoad);var a=document.createElement("IFRAME");a.width="0";a.height="0";a.style.display="none";a.src="about:blank";a.id=b._iframeName;a.name=b._iframeName;$addHandlers(a,{load:b._onIframeLoad$delegate});b._iframe=a;document.body.appendChild(b._iframe);a.contentWindow.name=b._iframeName},_removeIframe:function(){var b=null,a=this;a._removeTimer();if(a._iframe!=b){if(a._onIframeLoad$delegate!=b){$common.removeHandlers(a._iframe,{load:a._onIframeLoad$delegate});a._onIframeLoad$delegate=b}try{document.body.removeChild(a._iframe)}catch(c){a._frame.parentNode.removeChild(a._iframe)}a._iframe=b}},_createVForm:function(){var b=this,a,c="___postForm"+b.get_id();try{a=document.createElement('<form method="post" enctype="multipart/form-data" id="'+c+'" target="'+b._iframe.id+'">')}catch(d){a=document.createElement("form");a.setAttribute("id",c);a.setAttribute("method","post");a.setAttribute("target",b._iframe.id);a.setAttribute("enctype","multipart/form-data")}a.setAttribute("action","/");a.style.visibility="hidden";a.style.display="none";b._vForm=a;document.body.appendChild(b._vForm)},_removeVForm:function(){try{this._vForm&&document.body.removeChild(this._vForm)}catch(a){}},_removeTimer:function(){if(this._waitTimer!=null){window.clearTimeout(this._waitTimer);this._waitTimer=null}},_onIframeLoad:function(){var a=this;try{var b=a._iframe.contentWindow.document;if(b==null||b.location==null||!b.body||b.body.innerHTML==null||b.body.innerHTML=="")return;if(!a._isCancelUpload){var d=b.body.innerHTML;d=d.substring(d.indexOf('{"FileId'));var c=Sys.Serialization.JavaScriptSerializer.deserialize(d),e=new Sys.Extended.UI.AjaxFileUploadEventArgs(a._guid,c.StatusMessage,c.FileName,c.FileSize,c.ContentType,c.PostedUrl);if(e.get_statusMessage()=="Success"){a._removeTimer();a._uploadInput_complete(e)}else a._setDisableControls(false)}else{a._removeTimer();a._setAborted()}}catch(f){a._removeTimer();a._setError(f.message)}},_wait:function(){var a=this;if(a._waitTimer==null)return;var b=a;try{a._waitTimer=setTimeout(function(){b._wait()},100)}catch(c){setTimeout(function(){b._removeIframe();b._removeVForm()},100);a._waitTimer=null}},_onUploadOrAbort:function(){if(this._isUploading)this._cancelUpload();else this._doUpload()},_doUpload:function(){var a=this;if(!a._filesInQueue.length||a._filesInQueue.length<1)return;a._currentQueueIndex=-1;!a._isFileApiSupports&&a._createIframe();a._processNextFile()},_cancelUpload:function(){var a=this;a._setQueueStatuses("canceling",Sys.Extended.UI.Resources.AjaxFileUpload_Cancelling);a._setStatusMessage(Sys.Extended.UI.Resources.AjaxFileUpload_CancellingUpload);a._uploadOrCancelButton.style.disabled="disabled";a._isCancelUpload=true;a._isFileApiSupports&&a._executor.abort()},_getCurrentFileItem:function(){var a=this;return a._currentQueueIndex<a._filesInQueue.length?a._filesInQueue[a._currentQueueIndex]:null},_hideSelectFileButton:function(b){var c="disabled",a=this;if(a._isFileApiSupports){a._html5DropZone.disabled=b?c:"";a._html5InputFile.disabled=b?c:"";$common.setVisible(a._html5DropZone,!b)}$common.setVisible(a._selectFileButton.parentNode,!b)},_addToQueue:function(c){var a=this,b=new Sys.Extended.UI.AjaxFileUploadItem(a.get_id(),c,a._removeFromQueue$delegate);a._filesInQueue.push(b);a._showFilesCount();b.appendNodeTo(a._queueContainer);b.setStatus("pending",Sys.Extended.UI.Resources.AjaxFileUpload_Pending);a.get_maximumNumberOfFiles()>0&&a._filesInQueue.length>=a.get_maximumNumberOfFiles()&&a._hideSelectFileButton(true)},_removeFromQueue:function(a){Array.remove(this._filesInQueue,a);this._showFilesCount();this._hideSelectFileButton(false)},bind:function(b,a){return function(){b.apply(a,arguments)}},_setDisableControls:function(b){var a=this;a._isUploading=b;var c=b?"disabled":"";$common.setText(a._uploadOrCancelButton,b?Sys.Extended.UI.Resources.AjaxFileUpload_Cancel:Sys.Extended.UI.Resources.AjaxFileUpload_Upload);a._uploadOrCancelButton.setAttribute("class",b?"ajax_fileupload_cancelbutton":"ajax__fileupload_uploadbutton");if(a._isFileApiSupports){a._html5DropZone.disabled=c;a._html5InputFile.disabled=c}else a._inputFileElement.disabled=c},_validateFileType:function(c){if(this.get_allowedFileTypes()!=""){for(var b=this.get_allowedFileTypes().split(","),a=0;a<b.length;a++)if(b[a].toLowerCase()==c.toLowerCase())return true}else return true;return false},get_contextKey:function(){return this._contextKey},set_contextKey:function(a){this._contextKey=a},get_throbber:function(){return this._throbber},set_throbber:function(a){this._throbber=a},get_postBackUrl:function(){return this._postBackUrl},set_postBackUrl:function(a){this._postBackUrl=a},get_maximumNumberOfFiles:function(){return this._maximumNumberOfFiles},set_maximumNumberOfFiles:function(a){this._maximumNumberOfFiles=a},get_allowedFileTypes:function(){return this._allowedFileTypes},set_allowedFileTypes:function(a){this._allowedFileTypes=a},add_uploadComplete:function(a){this.get_events().addHandler("uploadComplete",a)},remove_uploadComplete:function(a){this.get_events().removeHandler("uploadComplete",a)},_raiseUploadComplete:function(c){var a=this._getCurrentFileItem();a.setStatus("uploaded",Sys.Extended.UI.Resources.AjaxFileUpload_Uploaded);a._isUploaded=true;a.hide();var b=this.get_events().getHandler("uploadComplete");b&&b(this,c)},add_uploadError:function(a){this.get_events().addHandler("uploadError",a)},remove_uploadError:function(a){this.get_events().removeHandler("uploadError",a)},raiseUploadError:function(b){var a=this.get_events().getHandler("uploadError");a&&a(this,b)}};Sys.Extended.UI.AjaxFileUpload._addEvent=function(a,b,c){if(a.attachEvent)a.attachEvent("on"+b,c);else a.addEventListener&&a.addEventListener(b,c,true)};Sys.Extended.UI.AjaxFileUpload._removeEvent=function(a,b,c){if(a.detachEvent)a.detachEvent("on"+b,c);else a.removeEventListener&&a.removeEventListener(b,c,true)};Sys.Extended.UI.AjaxFileUpload.utils={generateGuid:function(){var b,c,a;b="";for(a=0;a<32;a++){if(a==8||a==12||a==16||a==20)b=b+"-";c=Math.floor(Math.random()*16).toString(16).toUpperCase();b=b+c}return b},getFileName:function(a){if(!a)return"";if(a){var c=a.indexOf("\\")>=0?a.lastIndexOf("\\"):a.lastIndexOf("/"),b=a.substring(c);if(b.indexOf("\\")===0||b.indexOf("/")===0)b=b.substring(1);return b}return""},sizeToString:function(a){if(!a||a<=0)return"0 Kb";var c=["bytes","kb","MB","GB","TB","PB"],b=Math.floor(Math.log(a)/Math.log(1024));return(a/Math.pow(1024,Math.floor(b))).toFixed(2)+" "+c[b]}};Sys.Extended.UI.AjaxFileUpload.registerClass("Sys.Extended.UI.AjaxFileUpload",Sys.Extended.UI.ControlBase);Sys.Extended.UI.AjaxFileUpload.WebForm_OnSubmit=function(){var c="disabled",e=Sys.Extended.UI.AjaxFileUpload._originalWebForm_OnSubmit();if(e)for(var d=Sys.Application.getComponents(),b=0;b<d.length;b++){var a=d[b];if(Sys.Extended.UI.AjaxFileUpload.isInstanceOfType(a)){a._html5InputFile.disabled=c;a._inputFileElement.disabled=c}}return e};Sys.Extended.UI.AjaxFileUploadItem=function(e,c,d){var b=null,a=this;a._deleteButton=b;a._parentId=e;a._fileInputElement=c;a._container=b;a._fileInfoContainer=b;a._status=b;a._isUploaded=false;a._ui=a.initUI(d)};Sys.Extended.UI.AjaxFileUploadItem.prototype={initUI:function(g){var e='<span class="filename">',a=this,c=Sys.Extended.UI.AjaxFileUpload.utils.generateGuid(),h=a._lineItemHeight+"px";a._container=$common.createElementFromTemplate({nodeName:"div",properties:{id:a._parentId+"_FileItemContainer_"+c},cssClasses:["ajax__fileupload_fileItemInfo"]});a._fileInfoContainer=document.createElement("div");a._fileInfoContainer.setAttribute("align","left");$common.setStyle(a._fileInfoContainer,{display:"inline-block"});var b=document.createElement("span");b.setAttribute("id",a._parentId+"_FileItemInfo_"+c);if(a._fileInputElement.file){var d=a._fileInputElement.file;b.innerHTML=e+d.name+'</span> <span class="filetype">('+d.type+')</span> - <span class="filesize'+Sys.Extended.UI.AjaxFileUpload.utils.sizeToString(d.size)+"</span>"}else b.innerHTML=e+Sys.Extended.UI.AjaxFileUpload.utils.getFileName(a._fileInputElement.value)+"</span>";a._fileInfoContainer.appendChild(b);a._status=$common.createElementFromTemplate({nodeName:"span",properties:{id:a._parentId+"_FileItemStatus_"+c},cssClasses:["uploadstatus"]});a._fileInfoContainer.appendChild(a._status);a._deleteButton=$common.createElementFromTemplate({nodeName:"div",properties:{id:a._parentId+"_FileItemDeleteButton_"+c},cssClasses:["removeButton"]});$common.setText(a._deleteButton,Sys.Extended.UI.Resources.AjaxFileUpload_Remove);var f=a;$addHandlers(a._deleteButton,{click:function(){return function(){g(f);f.destroy()}}(a._deleteButton)});if(Sys.Browser.agent==Sys.Browser.InternetExplorer&&Sys.Browser.version<=8){a._container.appendChild(a._deleteButton);a._container.appendChild(a._fileInfoContainer)}else{a._container.appendChild(a._fileInfoContainer);a._container.appendChild(a._deleteButton)}return a._container},setStatus:function(a,b){$common.setText(this._status," ("+b+")");this._fileInfoContainer.setAttribute("class",a+"State")},disabled:function(a){if(a)this._deleteButton.disabled="disabled";else this._deleteButton.disabled=""},hide:function(){this._deleteButton.style.visibility="hidden"},destroy:function(){$common.removeElement(this._fileInputElement);$common.removeElement(this._deleteButton);$common.removeElement(this._ui)},get_fileInputElement:function(){return this._fileInputElement},appendNodeTo:function(a){a.appendChild(this._ui)},removeNodeFrom:function(a){a.removeChild(this._ui)}};Sys.Extended.UI.AjaxFileUploadEventArgs=function(g,b,e,f,c,d){var a=this;if(arguments.length!=6)throw Error.parameterCount();Sys.Extended.UI.AjaxFileUploadEventArgs.initializeBase(a);a._fileId=g;a._statusMessage=b;a._fileName=e;a._fileSize=f;a._contentType=c;a._postedUrl=d};Sys.Extended.UI.AjaxFileUploadEventArgs.prototype={get_fileId:function(){return this._fileId},get_fileName:function(){return this._fileName},get_statusMessage:function(){return this._statusMessage},get_fileSize:function(){return this._fileSize},get_contentType:function(){return this._contentType},get_postedUrl:function(){return this._postedUrl},set_postedUrl:function(){return this._postedUrl=value}};Sys.Extended.UI.AjaxFileUploadEventArgs.registerClass("Sys.Extended.UI.AjaxFileUploadEventArgs",Sys.EventArgs);